Description: <short summary of the patch>
 TODO: Put a short summary on the line above and replace this paragraph
 with a longer explanation of this change. Complete the meta-information
 with other relevant fields (see below for details). To make it easier, the
 information below has been extracted from the changelog. Adjust it or drop
 it.
 .
 network-manager-applet (1.20.0-3+ci202310161658+astra7) unstable; urgency=medium
 .
   *  Add a notification about NetworkManager has detected an IP address
     conflict (BT-21199).
   *  workaround for invisibale tray icon when Gdk/WindowScalingFactor >
     1 (BT-25391)
   *  fix margins in info dialog (BT-17377)
   *  desktop entry translation (BT-15076)
   *  fix new connection dialog black margins (BT-9836)
   *  tray icon theme
   *  Fix meson.build buildfix
Author: Aleksey V. Kolin <support@astralinux.ru>

---
The information above should follow the Patch Tagging Guidelines, please
checkout http://dep.debian.net/deps/dep3/ to learn about the format. Here
are templates for supplementary fields that you might want to add:

Origin: <vendor|upstream|other>, <url of original patch>
Bug: <url in upstream bugtracker>
Bug-Debian: https://bugs.debian.org/<bugnumber>
Bug-Ubuntu: https://launchpad.net/bugs/<bugnumber>
Forwarded: <no|not-needed|url proving that it has been forwarded>
Reviewed-By: <name and email of someone who approved the patch>
Last-Update: 2023-10-16

--- network-manager-applet-1.20.0.orig/Makefile.am
+++ network-manager-applet-1.20.0/Makefile.am
@@ -500,6 +500,7 @@ src_nm_applet_CPPFLAGS = \
 	$(LIBNMA_CFLAGS) \
 	$(LIBNM_CFLAGS) \
 	$(LIBSECRET_CFLAGS) \
+	$(LIBXSETTINGS_CFLAGS) \
 	$(NOTIFY_CFLAGS) \
 	$(MM_GLIB_CFLAGS) \
 	$(APPINDICATOR_CFLAGS)
@@ -510,6 +511,7 @@ src_nm_applet_LDADD = \
 	$(LIBNM_LIBS) \
 	$(LIBNMA_LIBS) \
 	$(LIBSECRET_LIBS) \
+	$(LIBXSETTINGS_LIBS) \
 	$(NOTIFY_LIBS) \
 	$(MM_GLIB_LIBS) \
 	$(APPINDICATOR_LIBS) \
--- network-manager-applet-1.20.0.orig/configure.ac
+++ network-manager-applet-1.20.0/configure.ac
@@ -49,6 +49,8 @@ dnl Checks for typedefs, structures, and
 dnl
 AC_TYPE_PID_T
 
+PKG_CHECK_MODULES(LIBXSETTINGS, [libxsettings-client])
+
 dnl
 dnl translation support
 dnl
--- network-manager-applet-1.20.0.orig/meson.build
+++ network-manager-applet-1.20.0/meson.build
@@ -108,6 +108,7 @@ gio_dep = dependency('gio-2.0', version:
 gmodule_export_dep = dependency('gmodule-export-2.0')
 libsecret_dep = dependency('libsecret-1', version: '>= 0.18')
 libnma_dep = dependency('libnma', version: '>= 1.8.27')
+libxsettings_dep = dependency('libxsettings-client')
 
 m_dep = cc.find_library('m')
 
@@ -252,9 +253,7 @@ desktop_files = [
 desktop_file_validate = find_program('desktop-file-validate', required: false)
 
 foreach desktop: desktop_files
-  i18n.merge_file(
-    desktop + '-desktop',
-    input: desktop + '.desktop.in',
+  i18n.merge_file(input: desktop + '.desktop.in',
     output: desktop + '.desktop',
     install: true,
     install_dir: nma_appdir,
@@ -273,9 +272,7 @@ endforeach
 
 appdata = 'nm-connection-editor.appdata.xml'
 
-i18n.merge_file(
-  'desktop',
-  input: appdata + '.in',
+i18n.merge_file(input: appdata + '.in',
   output: appdata,
   install: true,
   install_dir: join_paths(nma_datadir, 'metainfo'),
--- network-manager-applet-1.20.0.orig/po/ru.po
+++ network-manager-applet-1.20.0/po/ru.po
@@ -971,6 +971,20 @@ msgstr "_О программе"
 msgid "You are now connected to “%s”."
 msgstr "Вы подключены к «%s»."
 
+#: ../src/applet.c:2253
+msgid "NetworkManager has detected an IP address conflict."
+msgstr "NetworkManager обнаружил конфликт IP-адресов."
+
+#: ../src/applet.c:2254
+msgid ""
+"Another computer on this network has the same IP address as this computer.\n"
+"Contact your network administrator for help resolving this issue.\n"
+"More details are available in the system event log."
+msgstr ""
+"В этой сети уже есть компьютер с таким же IP-адресом.\n"
+"Обратитесь к системному администратору для решения этой проблемы.\n"
+"Дополнительные сведения см. в системном журнале событий."
+
 #: src/applet.c:2270
 msgid "Disconnected"
 msgstr "Соединение разорвано"
--- network-manager-applet-1.20.0.orig/src/applet.c
+++ network-manager-applet-1.20.0/src/applet.c
@@ -2124,8 +2124,8 @@ foo_set_icon (NMApplet *applet, guint32
 #endif  /* WITH_APPINDICATOR */
 
 	/* Load the pixbuf by icon name */
-	if (icon_name && !pixbuf)
-		pixbuf = nma_icon_check_and_load (icon_name, applet);
+	if (icon_name /*&& !pixbuf*/) //alex: force icon_name using
+		pixbuf = nma_tray_icon_check_and_load (icon_name, applet);
 
 	/* Ignore setting of the same icon as is already displayed */
 	if (applet->icon_layers[layer] == pixbuf)
@@ -2156,7 +2156,7 @@ foo_set_icon (NMApplet *applet, guint32
 			                      GDK_INTERP_NEAREST, 255);
 		}
 	} else
-		pixbuf = nma_icon_check_and_load ("nm-no-connection", applet);
+		pixbuf = nma_tray_icon_check_and_load ("nm-no-connection", applet); //alex
 
 	gtk_status_icon_set_from_pixbuf (applet->status_icon, pixbuf);
 }
@@ -2239,6 +2239,9 @@ foo_device_state_changed_cb (NMDevice *d
 
 	dclass = get_device_class (device, applet);
 
+	// Save the reason for informing the user later.
+	applet->state_reason = reason;
+
 	if (dclass && dclass->device_state_changed)
 		dclass->device_state_changed (device, new_state, old_state, reason, applet);
 
@@ -2292,10 +2295,21 @@ foo_client_state_changed_cb (NMClient *c
 
 	switch (nm_client_get_state (client)) {
 	case NM_STATE_DISCONNECTED:
-		applet_do_notify_with_pref (applet, _("Disconnected"),
-		                            _("The network connection has been disconnected."),
-		                            "nm-no-connection",
-		                            PREF_DISABLE_DISCONNECTED_NOTIFICATIONS);
+		if (NM_DEVICE_STATE_REASON_IP_ADDRESS_DUPLICATE == applet->state_reason) {
+			applet_do_notify_with_pref (applet,
+				_("NetworkManager has detected an IP address conflict."),
+				_("Another computer on this network has the same IP address as this computer.\n"
+				"Contact your network administrator for help resolving this issue.\n"
+				"More details are available in the system event log."),
+				"nm-no-connection",
+				PREF_DISABLE_DISCONNECTED_NOTIFICATIONS);
+		}
+		else {
+			applet_do_notify_with_pref (applet, _("Disconnected"),
+			                            _("The network connection has been disconnected."),
+			                            "nm-no-connection",
+			                            PREF_DISABLE_DISCONNECTED_NOTIFICATIONS);
+		}
 		break;
 	default:
 		break;
@@ -3054,6 +3068,37 @@ static void nma_icons_free (NMApplet *ap
 		g_clear_object (&applet->icon_layers[i]);
 }
 
+GdkPixbuf *  //alex
+nma_tray_icon_check_and_load (const char *name, NMApplet *applet)
+{
+	GError *error = NULL;
+	GdkPixbuf *icon;
+
+	g_assert (name != NULL);
+	g_assert (applet != NULL);
+
+	/* icon already loaded successfully */
+	if (g_hash_table_lookup_extended (applet->icon_cache_tray, name, NULL, (gpointer) &icon))
+		return icon;
+
+	/* Try to load the icon; if the load fails, log the problem, and set
+	 * the icon to the fallback icon if requested.
+	 */
+	if (!applet->icon_theme_tray)
+        return nma_icon_check_and_load (name, applet);
+	 
+	if (!(icon = gtk_icon_theme_load_icon (applet->icon_theme_tray, name, applet->icon_size, GTK_ICON_LOOKUP_FORCE_SIZE, &error))) {
+		g_warning ("failed to load icon \"%s\": %s", name, error->message);
+		g_clear_error (&error);
+        return nma_icon_check_and_load (name, applet); //alex
+		//icon = nm_g_object_ref (applet->fallback_icon);
+	}
+
+	g_hash_table_insert (applet->icon_cache_tray, g_strdup (name), icon);
+
+	return icon;
+}
+
 GdkPixbuf *
 nma_icon_check_and_load (const char *name, NMApplet *applet)
 {
@@ -3095,6 +3140,7 @@ nma_icons_reload (NMApplet *applet)
 	g_return_if_fail (applet->icon_size > 0);
 
 	g_hash_table_remove_all (applet->icon_cache);
+	g_hash_table_remove_all (applet->icon_cache_tray); //alex
 	nma_icons_free (applet);
 
 	if (applet->fallback_icon)
@@ -3128,8 +3174,62 @@ static void nma_icon_theme_changed (GtkI
 	applet_schedule_update_icon (applet);
 }
 
+//alex: xsettings processing -----------------------------------------------------------
+static void _xsettings_notify_cb(const char *name, XSettingsAction action, XSettingsSetting *setting, void *data)
+{
+  NMApplet *applet = (NMApplet *)data;
+
+  if (!data || !setting || !name) return;
+  if (action != XSETTINGS_ACTION_NEW && action != XSETTINGS_ACTION_CHANGED) return;
+  if (strcmp(name, "Fly/TrayIconThemeName")!=0 || setting->type != XSETTINGS_TYPE_STRING) return;
+
+  //g_debug("xsettings_notify_cb, theme=%s new=%s",applet->icon_theme_tray_name,setting->data.v_string);
+  if (applet->icon_theme_tray_name) {
+    if (strcmp(applet->icon_theme_tray_name, setting->data.v_string) == 0) return;
+    free(applet->icon_theme_tray_name); applet->icon_theme_tray_name=NULL;
+  }
+
+  if (!applet->icon_theme_tray) applet->icon_theme_tray = gtk_icon_theme_new();
+  applet->icon_theme_tray_name = strdup(setting->data.v_string);
+  gtk_icon_theme_set_custom_theme (applet->icon_theme_tray,applet->icon_theme_tray_name);
+
+  nma_icon_theme_changed(applet->icon_theme_tray, applet);
+}
+
+static GdkFilterReturn _xsettings_manager_filter (GdkXEvent *xevent, GdkEvent *event, gpointer data)
+{
+  if (!data) return GDK_FILTER_CONTINUE;
+
+  XEvent *xev = xevent;
+  NMApplet  *applet = (NMApplet *)data;
+
+  //g_debug("xsettings_manager_filterb xev=%p applet=%p",xev,data);
+  if (applet->xsettings_client) xsettings_client_process_event(applet->xsettings_client, xev);
+
+  return GDK_FILTER_CONTINUE;
+}
+
+static void _xsettings_watch_cb(Window window, Bool is_start, long mask, void  *data)
+{
+  if (!data) return;
+/*
+  GdkWindow * gw = NULL;
+  gw = gdk_x11_window_foreign_new_for_display (gdk_display_get_default(), window);
+  gw = gdk_x11_window_lookup_for_display(gdk_display_get_default(), window);
+  g_debug("xsettings_watch_cb win=%d gw=%p is_start=%d data=%p",window,gw,is_start,data);
+*/
+  if (is_start) gdk_window_add_filter(NULL/*gw*/, _xsettings_manager_filter, data);
+}
+//-------------------------------------------------------------------------------------------
+
 static void nma_icons_init (NMApplet *applet)
 {
+    XSettingsSetting *s;
+    GdkDisplay* gd = gdk_display_get_default();
+    Display* d = GDK_DISPLAY_XDISPLAY(gd);
+
+    gdk_x11_display_set_window_scale(gd,1); //alex: workaround for invisibale tray icon when Gdk/WindowScalingFactor > 1
+
 	gboolean path_appended;
 
 	if (applet->icon_theme) {
@@ -3144,6 +3244,23 @@ static void nma_icons_init (NMApplet *ap
 	else
 		applet->icon_theme = gtk_icon_theme_get_default ();
 
+    //alex: load tray icon theme-------------------------------------------------------------
+    //g_debug("nma_icons_init: get white or back or none theme from xsettings");
+    if (applet->icon_theme_tray)      { g_clear_object (&applet->icon_theme_tray); applet->icon_theme_tray =NULL; }
+    if (applet->icon_theme_tray_name) { free(applet->icon_theme_tray_name); applet->icon_theme_tray_name=NULL; }
+    if (applet->xsettings_client)     { xsettings_client_destroy(applet->xsettings_client); applet->xsettings_client=NULL; }
+
+    applet->xsettings_client = xsettings_client_new(d, DefaultScreen(d), _xsettings_notify_cb, _xsettings_watch_cb, (void *)applet );
+    if (applet->xsettings_client &&
+        xsettings_client_get_setting(applet->xsettings_client,"Fly/TrayIconThemeName",&s)==XSETTINGS_SUCCESS &&
+        s->data.v_string && *(s->data.v_string))
+    {
+          applet->icon_theme_tray_name = strdup(s->data.v_string);
+          applet->icon_theme_tray = gtk_icon_theme_new();
+          gtk_icon_theme_set_custom_theme (applet->icon_theme_tray,applet->icon_theme_tray_name);
+    }
+    //----------------------------------------------------------------------------------
+
 	/* If not done yet, append our search path */
 	path_appended = GPOINTER_TO_INT (g_object_get_data (G_OBJECT (applet->icon_theme),
 	                                 "NMAIconPathAppended"));
@@ -3380,6 +3497,14 @@ applet_startup (GApplication *app, gpoin
 	                                            g_str_equal,
 	                                            g_free,
 	                                            nm_g_object_unref);
+	applet->icon_cache_tray = g_hash_table_new_full (g_str_hash, //alex
+	                                            g_str_equal,
+	                                            g_free,
+	                                            nm_g_object_unref);
+    applet->icon_theme_tray     =NULL;
+    applet->icon_theme_tray_name=NULL;
+    applet->xsettings_client    =NULL;
+
 	nma_icons_init (applet);
 
 	if (!notify_is_initted ())
@@ -3441,6 +3566,13 @@ static void finalize (GObject *object)
 	g_clear_object (&applet->status_icon);
 	g_clear_object (&applet->menu);
 	g_clear_pointer (&applet->icon_cache, g_hash_table_destroy);
+	
+	//alex: destoy tray icon theme and xsettings
+	g_clear_pointer (&applet->icon_cache_tray, g_hash_table_destroy);
+	if (applet->icon_theme_tray_name) free(applet->icon_theme_tray_name);
+	if (applet->xsettings_client) xsettings_client_destroy(applet->xsettings_client);
+	g_clear_object (&applet->icon_theme_tray);
+	
 	g_clear_object (&applet->fallback_icon);
 	g_free (applet->tip);
 	nma_icons_free (applet);
--- network-manager-applet-1.20.0.orig/src/applet.h
+++ network-manager-applet-1.20.0/src/applet.h
@@ -33,6 +33,9 @@
 #include <libmm-glib.h>
 #endif
 
+//alex
+#include <xsettings-client.h>
+
 #define NM_TYPE_APPLET              (nma_get_type())
 #define NM_APPLET(object)           (G_TYPE_CHECK_INSTANCE_CAST((object), NM_TYPE_APPLET, NMApplet))
 #define NM_APPLET_CLASS(klass)      (G_TYPE_CHECK_CLASS_CAST((klass), NM_TYPE_APPLET, NMAppletClass))
@@ -76,6 +79,9 @@ typedef struct {
 
 	GSettings *gsettings;
 
+	// For detect an IP address conflict
+	NMDeviceStateReason state_reason;
+
 #if WITH_WWAN
 	MMManager *mm1;
 	gboolean   mm1_running;
@@ -105,10 +111,15 @@ typedef struct {
 #define NUM_VPN_CONNECTING_FRAMES 14
 
 	GtkIconTheme *  icon_theme;
+	GtkIconTheme *  icon_theme_tray; //alex
+	char * icon_theme_tray_name; //alex
 	GHashTable *    icon_cache;
+	GHashTable *    icon_cache_tray; //alex
 	GdkPixbuf *     fallback_icon;
 	int             icon_size;
 
+    XSettingsClient *xsettings_client; //alex
+
 	/* Active status icon pixbufs */
 	GdkPixbuf *     icon_layers[ICON_LAYER_MAX + 1];
 
@@ -282,6 +293,8 @@ GtkWidget * applet_new_menu_item_helper
 
 GdkPixbuf * nma_icon_check_and_load (const char *name,
                                      NMApplet *applet);
+GdkPixbuf * nma_tray_icon_check_and_load (const char *name,
+                                     NMApplet *applet);
 
 gboolean applet_wifi_connect_to_hidden_network (NMApplet *applet);
 gboolean applet_wifi_create_wifi_network (NMApplet *applet);
--- network-manager-applet-1.20.0.orig/src/connection-editor/ce-new-connection.ui
+++ network-manager-applet-1.20.0/src/connection-editor/ce-new-connection.ui
@@ -55,7 +55,7 @@
                 <property name="use_underline">True</property>
               </object>
               <packing>
-                <property name="expand">False</property>
+                <property name="expand">True</property>
                 <property name="fill">False</property>
                 <property name="position">0</property>
               </packing>
@@ -70,14 +70,14 @@
                 <property name="use_underline">True</property>
               </object>
               <packing>
-                <property name="expand">False</property>
+                <property name="expand">True</property>
                 <property name="fill">False</property>
                 <property name="position">1</property>
               </packing>
             </child>
           </object>
           <packing>
-            <property name="expand">False</property>
+            <property name="expand">True</property>
             <property name="fill">True</property>
             <property name="pack_type">end</property>
             <property name="position">0</property>
@@ -102,7 +102,7 @@
                 <property name="icon_size">6</property>
               </object>
               <packing>
-                <property name="expand">False</property>
+                <property name="expand">True</property>
                 <property name="fill">True</property>
                 <property name="position">0</property>
               </packing>
@@ -125,7 +125,7 @@
                     </attributes>
                   </object>
                   <packing>
-                    <property name="expand">False</property>
+                    <property name="expand">True</property>
                     <property name="fill">False</property>
                     <property name="position">0</property>
                   </packing>
@@ -142,7 +142,7 @@ If you are creating a VPN, and the VPN c
                     <property name="xalign">0</property>
                   </object>
                   <packing>
-                    <property name="expand">False</property>
+                    <property name="expand">True</property>
                     <property name="fill">False</property>
                     <property name="position">1</property>
                   </packing>
@@ -188,7 +188,7 @@ If you are creating a VPN, and the VPN c
                     </child>
                   </object>
                   <packing>
-                    <property name="expand">False</property>
+                    <property name="expand">True</property>
                     <property name="fill">False</property>
                     <property name="padding">6</property>
                     <property name="position">2</property>
@@ -203,7 +203,7 @@ If you are creating a VPN, and the VPN c
             </child>
           </object>
           <packing>
-            <property name="expand">False</property>
+            <property name="expand">True</property>
             <property name="fill">True</property>
             <property name="position">1</property>
           </packing>
--- network-manager-applet-1.20.0.orig/src/meson.build
+++ network-manager-applet-1.20.0/src/meson.build
@@ -48,6 +48,7 @@ deps = [
   libnotify_dep,
   libsecret_dep,
   m_dep,
+  libxsettings_dep,
   libutils_libnm_dep
 ]
 
